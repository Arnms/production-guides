# AWS Cost Optimization Production Guide

## 📊 프로젝트 개요

**성과 요약**: 월 1,000만원 → 150만원 (85% 비용 절감)  
**기간**: 약 3개월  
**주요 접근법**: 인프라 사이즈 최적화 및 Serverless 아키텍처 도입

---

## 🔍 Phase 1: 현황 분석 및 문제점 파악

### 1.1 초기 상황 분석
- **문제점**: 이전 개발자 부재로 인한 인프라 과잉 구성
- **주요 이슈**:
  - 과도한 EC2 인스턴스 사이즈 (실제 사용량 대비 오버 프로비저닝)
  - RDS 인스턴스 사이즈 최적화 필요
  - 상시 실행되는 서비스들의 비효율적 운영

### 1.2 데이터 기반 현황 분석 체크리스트
- [ ] **사용자 트래픽 데이터 수집**
  - DAU (Daily Active Users) 패턴 분석
  - WAU (Weekly Active Users) 주간 변동성 확인
  - MAU (Monthly Active Users) 기반 성장 추이 파악
- [ ] AWS Cost Explorer를 통한 월별 비용 추이 분석
- [ ] 서비스별 리소스 사용률 모니터링 (CloudWatch)
- [ ] 사용자 수 대비 실제 서버 부하 상관관계 분석
- [ ] 불필요한 서비스 및 리소스 식별

---

## ⚡ Phase 2: EC2 인스턴스 사이즈 최적화

### 2.1 사이즈 다운그레이드 전략
**단계별 접근법** (3개월에 걸쳐 점진적 적용)

#### 2.1.1 1단계: 개발/테스트 환경 최적화
- **목적**: 리스크 최소화 및 성능 영향 측정
- **방법**: 
  - 개발 환경 인스턴스 사이즈 보수적 축소 (안전 마진 확보)
  - 성능 모니터링 및 임계값 설정
  - 애플리케이션 응답 시간 비교 분석

**실제 경험한 이슈와 해결 과정**:
- **문제**: 보수적으로 사이즈를 축소했음에도 메모리 부족 현상 발생
- **원인 분석**: 서버 메모리 사용량 패턴 추적 및 분석
- **근본 원인 발견**: 클라이언트에서 API 호출 로직 문제
  - 불필요한 중복 호출
  - 메모리 리크를 유발하는 API 사용 패턴
- **해결책**: 
  - 서버 사이즈 최적화와 동시에 클라이언트 코드 개선
  - API 호출 최적화로 서버 메모리 사용량 근본적 감소
- **결과**: 예상보다 더 큰 폭의 인스턴스 사이즈 축소 가능

#### 2.1.2 2단계: 스테이징 환경 최적화
- **목적**: 프로덕션 환경 적용 전 검증
- **방법**:
  - 부하 테스트 실행
  - 메모리 사용량 및 CPU 사용률 모니터링
  - 데이터베이스 연결 풀 최적화

#### 2.1.3 3단계: 프로덕션 환경 최적화
- **목적**: 실제 비용 절감 효과 구현
- **방법**:
  - 유지보수 시간대 활용한 인스턴스 타입 변경
  - 실시간 모니터링 및 롤백 계획 수립
  - 성능 임계값 기반 자동 알림 설정

### 2.2 인스턴스 타입 결정 방법론
**데이터 기반 의사결정 프로세스**:
1. **사용자 트래픽 분석**
   - DAU (Daily Active Users) 패턴 분석
   - WAU (Weekly Active Users) 추이 검토
   - MAU (Monthly Active Users) 기반 피크 예측

2. **리소스 사용량 매핑**
   - 사용자 수 대비 실제 서버 리소스 사용률 측정
   - 피크 시간대 vs 평상시 사용량 비교
   - 동시 접속자 수 기반 필요 리소스 계산

3. **인스턴스 사이즈 결정** (예시)
```
기존: 과도한 프로비저닝 (실제 사용률 20-30%)
최적화: DAU/WAU 패턴 기반 적정 사이즈 선택
결과: 실제 사용률 60-70%로 효율성 개선
```

### 2.3 모니터링 및 알림 설정
- **CloudWatch 메트릭 설정**:
  - CPU 사용률 > 80% 시 알림
  - 메모리 사용률 > 85% 시 알림
  - 네트워크 I/O 임계값 모니터링

---

## 🗄️ Phase 3: RDS 인스턴스 최적화

### 3.1 데이터베이스 성능 분석
- **Performance Insights 활용**:
  - 쿼리 성능 분석
  - 느린 쿼리 식별 및 최적화
  - 인덱스 사용 패턴 분석

### 3.2 RDS 사이즈 최적화 전략
- **단계적 축소**:
  - 연결 수 모니터링
  - IOPS 사용량 분석
  - 메모리 사용 패턴 확인
- **백업 및 복구 계획**:
  - 스냅샷 생성
  - 롤백 시나리오 준비

---

## 🚀 Phase 4: Serverless 아키텍처 도입

### 4.1 Lambda 전환 대상 식별
**게임 서비스 공지사항 시스템 예시**
- **기존**: 상시 실행되는 EC2 인스턴스
- **개선**: 이벤트 기반 Lambda 함수
- **효과**: 사용한 만큼만 비용 발생

### 4.2 Serverless 아키텍처 설계 (예시)
```yaml
# serverless.yml 예시 구성
service: notification-system

provider:
  name: aws
  runtime: nodejs18.x
  region: ap-northeast-2
  environment:
    DB_HOST: ${env:DB_HOST}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}

functions:
  notificationHandler:
    handler: handler.notification
    events:
      - s3:
          bucket: service-notifications
          event: s3:ObjectCreated:*
    timeout: 300
    memorySize: 256
```

### 4.3 S3 트리거 기반 자동화
- **이벤트 기반 처리**:
  - S3 버킷에 공지사항 파일 업로드
  - Lambda 함수 자동 트리거
  - 데이터베이스 업데이트 및 알림 발송

### 4.4 Lambda 배포 가이드 (예시)
```bash
# 환경 설정
npm install -g serverless

# 프로젝트 설정
npm install

# 환경 변수 설정 (.env 파일 예시)
REGION=ap-northeast-2
BUCKET=service-notifications
DB_HOST=your-db-host
DB_USER=your-db-user
DB_PASSWORD=your-db-password
DB_SCHEMA=service_db
DB_PORT=3306

# 배포 실행
sls deploy
```

---

## 📈 성과 측정 및 모니터링

### 5.1 비용 절감 효과 측정 (실제 성과)
- **월별 비용 비교**:
  - 기존: 1,000만원
  - 최적화 후: 150만원
  - 절감율: 85%

### 5.2 성능 지표 모니터링 (목표 기준 예시)
- **응답 시간**: 평균 200ms 이하 유지
- **가용성**: 99.9% 이상
- **오류율**: 0.1% 이하

### 5.3 지속적 모니터링 체계
- **주간 리포트**: 비용 및 성능 지표 분석
- **월간 리뷰**: 추가 최적화 포인트 식별
- **분기별 아키텍처 검토**: 신규 서비스 추가 시 비용 최적화 적용

---

## 🛠️ 구현 시 주의사항

### 6.1 리스크 관리 및 문제 해결 경험
- **단계적 적용**: 한 번에 모든 변경 사항 적용 금지
- **롤백 계획**: 각 단계별 롤백 시나리오 준비
- **성능 모니터링**: 실시간 모니터링 및 알림 체계 구축

**실무에서 마주한 예상치 못한 문제들**:
1. **보수적 접근에도 발생한 메모리 이슈**
   - 문제: 안전 마진을 두고 축소했지만 메모리 부족 발생
   - 대응: 서버 측면만이 아닌 전체 시스템 관점에서 원인 분석
   
2. **근본 원인 분석의 중요성**
   - 서버 리소스 문제로 보였지만 실제로는 클라이언트 코드 이슈
   - 인프라 최적화 과정에서 애플리케이션 레벨 개선점도 발견
   
3. **Cross-functional 협업의 필요성**
   - 인프라팀 단독 작업이 아닌 클라이언트 개발팀과의 협업 필요
   - 시스템 전체적 관점에서의 최적화 접근

### 6.2 팀 커뮤니케이션
- **사전 공지**: 서비스 영향도 및 일정 사전 안내
- **문서화**: 변경 사항 및 절차 상세 기록
- **교육**: 팀원 대상 새로운 아키텍처 교육

### 6.3 보안 고려사항
- **IAM 권한 최소화**: Serverless 함수별 최소 권한 적용
- **환경 변수 암호화**: 민감 정보 AWS Systems Manager Parameter Store 활용
- **VPC 설정**: 필요 시 Lambda 함수 VPC 내 배치

---

## 🎯 추가 최적화 방안

### 7.1 Reserved Instance 활용 (추가 최적화 방안)
- **장기 운영 예상 인스턴스**: 1년 또는 3년 약정으로 추가 비용 절감
- **예상 절감율**: 30-50% 추가 절감 가능

### 7.2 Spot Instance 활용 (배치 작업용)
- **배치 처리 작업**: 중단 가능한 작업에 Spot Instance 활용
- **비용 절감 효과**: 최대 90% 절감 가능

### 7.3 Auto Scaling 최적화
- **동적 스케일링**: 트래픽 패턴 기반 자동 확장/축소
- **예측 스케일링**: 과거 패턴 분석 기반 사전 스케일링

---

## 📋 체크리스트

### 사전 준비
- [ ] 현재 인프라 비용 분석 완료
- [ ] 성능 기준선 설정
- [ ] 백업 및 스냅샷 생성
- [ ] 롤백 계획 수립

### 실행 단계
- [ ] 개발 환경 최적화 완료
- [ ] 스테이징 환경 검증 완료
- [ ] 프로덕션 환경 적용 완료
- [ ] Serverless 아키텍처 적용 완료

### 사후 관리
- [ ] 성능 모니터링 설정 완료
- [ ] 비용 알림 설정 완료
- [ ] 문서화 및 팀 공유 완료
- [ ] 정기 검토 일정 수립

---

## 💡 경험 기반 핵심 인사이트

1. **데이터 기반 의사결정**: DAU/WAU/MAU 같은 실제 사용자 데이터를 기반으로 인프라 사이즈를 결정하는 것이 핵심
2. **전체 시스템 관점**: 서버 최적화 과정에서 클라이언트/프론트엔드 코드 이슈도 함께 발견하고 개선
3. **보수적 접근의 한계**: 안전 마진을 두어도 예상치 못한 문제 발생 가능 → 근본 원인 분석 중요
4. **Cross-functional 협업**: 인프라 최적화는 단순히 서버팀만의 일이 아님
5. **문제를 기회로**: 메모리 부족 이슈가 클라이언트/프론트엔드 코드 개선의 계기가 됨
6. **지속적 모니터링**: 최적화 이후에도 지속적인 모니터링 필수

이 가이드는 실제 85% 비용 절감 경험을 바탕으로 작성되었으며, 유사한 환경에서 재현 가능한 실무 중심의 접근법을 제시합니다.
